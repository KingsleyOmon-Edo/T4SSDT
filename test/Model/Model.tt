<#@ template debug="false" hostspecific="true" language="C#" #>
<#@ output extension=".Generated.cs" #>
<#@ assembly name="System.Core" #>
<#@ assembly name="EnvDTE" #>
<#@ assembly name="System.Data" #>
<#@ import namespace="System.IO" #>
<#@ import namespace="EnvDTE" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ include file="Model.Settings.ttinclude" once="true"#><##>
<#@ include file="..\..\src\T4SSDT.ttinclude" once="true"#><##>
//------------------------------------------------------------------------------
// <auto-generated>
// T4SSDT Data access layer code generator.
// </auto-generated>
//------------------------------------------------------------------------------
using System;
using System.CodeDom.Compiler;

namespace Model
{
<#
    var hostServiceProvider = (IServiceProvider)this.Host;
    var dte = (DTE)hostServiceProvider.GetService(typeof(DTE));
    TSqlModel model = null;

    foreach (Project project in dte.Solution)
    {
        if (project.Kind == "{00d1a9c2-b5f0-4af3-8072-f6c62b433612}")
        {
            model = GenerateModelFromProjectItems(project.ProjectItems);
            break;
        }
    }
    
    if (null == model)
        Error("Database project was not found!");

/**************************************** TABLE POCO GENERATOR *********************************************/
    var tables = model.GetObjects(DacQueryScopes.All, ModelSchema.Table).ToArray();
    foreach (var table in tables)
    {
        if (ExcludeFromPOCO.Contains(table.Name.Parts[1]))
            continue;
#>
    [GeneratedCode("T4SSDT", "1.0")]
    public partial class <#= Singularizer.Singularize(table.Name.Parts[1]) #>
    {
<#
        PushIndent("        ");
		var columns = table.GetReferenced(Table.Columns).ToArray();
        foreach (var column in columns)
        {
            if (ExcludeColumnsFromCRUD.Contains(column.Name.ToString()))
                continue;

			var info = GetTableColumnInfo(column);
            WriteLine("public {0} {1} {{ get; set; }}", info.dataType, info.name);
        }

        ClearIndent();
#>
    }

<#
    }

/***************************************** VIEW POCO GENERATOR *********************************************/
	var views = model.GetObjects(DacQueryScopes.All, ModelSchema.View).ToArray();
	foreach (var view in views)
	{
		if (ExcludeFromPOCO.Contains(view.Name.Parts[1]))
            continue;
#>
    [GeneratedCode("T4SSDT", "1.0")]
    public partial class <#= Singularizer.Singularize(view.Name.Parts[1]) #>
    {
<#
		PushIndent("        ");
		var columns = view.GetReferenced(View.Columns).ToArray();
        foreach (var column in columns)
        {
            if (ExcludeColumnsFromCRUD.Contains(column.Name.ToString()))
                continue;

			var info = GetViewColumnInfo(column);
            WriteLine("public {0} {1} {{ get; set; }}", info.dataType, info.name);
        }

        ClearIndent();
#>
    }

<#
	}

model.Dispose();
#>
}